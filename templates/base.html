<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}PujaPath - Your trusted platform for Vedic rituals and spiritual services{% endblock %}">
    <title>{% block title %}PujaPath - Your Spiritual Journey Partner{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }

        /* Smooth Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.8s ease-out;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Card Hover Effects */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        /* Shopping Cart Badge */
        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeInUp 0.3s ease-out;
        }

        /* Swiper Navigation Buttons Styling */
        .swiper-button-next,
        .swiper-button-prev {
            color: #2563eb !important;
            background: white;
            width: 45px !important;
            height: 45px !important;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 20px !important;
            font-weight: bold;
        }

        .swiper-button-next:hover,
        .swiper-button-prev:hover {
            background: #2563eb;
            color: white !important;
            transform: scale(1.1);
        }

        /* Swiper Pagination Styling */
        .swiper-pagination-bullet {
            width: 12px;
            height: 12px;
            background: #cbd5e1;
            opacity: 1;
            transition: all 0.3s ease;
        }

        .swiper-pagination-bullet-active {
            background: #2563eb;
            width: 30px;
            border-radius: 6px;
        }

        .swiper-pagination {
            bottom: 10px !important;
        }

        /* Add space for pagination */
        .swiper {
            padding-bottom: 50px;
        }

        /* Featured slider specific styling */
        .featured-slider .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Button Pulse Animation */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .btn-pulse:hover {
            animation: pulse 1s infinite;
        }

        /* Scroll Reveal */
        .scroll-reveal {
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.8s ease-out;
        }

        .scroll-reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background: rgba(255, 255, 255, 1);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 9999;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #64748b;
            font-size: 0.7rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .bottom-nav-item.active {
            color: #7c3aed;
        }

        .bottom-nav-item i {
            font-size: 1.25rem;
            margin-bottom: 2px;
        }

        /* Glassmorphism Sticky Header */
        .sticky-header-modern {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        {% block extra_styles %}{% endblock %}
    </style>
</head>

<body class="bg-gray-100">

    {% include 'partials/announcement_bar.html' %}
    {% include 'partials/navbar.html' %}
    {% include 'partials/bottom_nav.html' %}

    <!-- Main Content -->
    <main id="main-content" class="{% block main_class %}pt-8{% endblock %}">
        {% block content %}{% endblock %}
    </main>

    {% include 'partials/cart_drawer.html' %}
    {% include 'partials/footer.html' %}
    {% include 'partials/auth_modals.html' %}

    <!-- Scripts -->
    <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>

    <!-- Firebase SDK for Phone Auth -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "{{ config.get('FIREBASE_API_KEY', '') }}",
            authDomain: "{{ config.get('FIREBASE_AUTH_DOMAIN', '') }}",
            projectId: "{{ config.get('FIREBASE_PROJECT_ID', '') }}"
        };
        if (firebaseConfig.apiKey) {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase SDK initialized");
        }
    </script>

    <script>
        // Shopping Cart Functionality
        let cart = JSON.parse(localStorage.getItem('pujapath_cart')) || [];

        // XSS protection: escape HTML entities
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle Google OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const userStr = urlParams.get('user');
        
        if (token) {
            localStorage.setItem('token', token);
            if (userStr) {
                localStorage.setItem('user', userStr);
            }
            // Clean URL
            window.history.replaceState({}, document.title, window.location.pathname);
            // Reload to update UI
            window.location.reload();
        }

        function updateCartUI() {
            const cartCount = document.getElementById('cart-count');
            const cartItemCount = document.getElementById('cart-item-count');
            const cartItems = document.getElementById('cart-items');
            const cartSubtotal = document.getElementById('cart-subtotal');
            const cartTotal = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            const emptyMessage = document.getElementById('empty-cart-message');

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

            if (cart.length === 0) {
                if (cartCount) cartCount.classList.add('hidden');
                if (emptyMessage) emptyMessage.classList.remove('hidden');
                if (cartItemCount) cartItemCount.textContent = '0';
                if (cartSubtotal) cartSubtotal.textContent = '0';
                if (cartTotal) cartTotal.textContent = '0';
                if (checkoutBtn) checkoutBtn.disabled = true;

                // Clear items except empty message
                if (cartItems) {
                    const itemsToRemove = cartItems.querySelectorAll('.cart-item');
                    itemsToRemove.forEach(item => item.remove());
                }
            } else {
                if (cartCount) {
                    cartCount.classList.remove('hidden');
                    cartCount.textContent = totalItems;
                }
                if (cartItemCount) cartItemCount.textContent = totalItems;
                if (emptyMessage) emptyMessage.classList.add('hidden');
                if (checkoutBtn) checkoutBtn.disabled = false;

                let subtotal = 0;
                const itemsHTML = cart.map(item => {
                    subtotal += item.price * item.quantity;
                    return `
                    <div class="cart-item flex items-center gap-4 bg-gray-50 p-4 rounded-xl hover:bg-gray-100 transition-colors">
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${escapeHtml(item.name)}</h4>
                            <p class="text-orange-600 font-semibold text-sm">₹${item.price} × ${item.quantity}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="updateQuantity(${item.id}, -1)" class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full font-bold transition-colors">-</button>
                            <span class="w-8 text-center font-bold">${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, 1)" class="w-8 h-8 bg-orange-500 hover:bg-orange-600 text-white rounded-full font-bold transition-colors">+</button>
                        </div>
                        <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700 font-bold transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                `;
                }).join('');

                if (cartItems) {
                    cartItems.innerHTML = itemsHTML;
                }

                if (cartSubtotal) cartSubtotal.textContent = subtotal;
                if (cartTotal) cartTotal.textContent = subtotal;
            }

            localStorage.setItem('pujapath_cart', JSON.stringify(cart));
        }

        function addToCart(id, name, price, type = 'product') {
            const existingItem = cart.find(item => item.id === id && item.type === type);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ id, name, price, type, quantity: 1 });
            }
            updateCartUI();

            // Auto-open cart drawer
            const drawer = document.getElementById('cart-drawer');
            const overlay = document.getElementById('cart-overlay');
            if (drawer && drawer.classList.contains('translate-x-full')) {
                drawer.classList.remove('translate-x-full');
                overlay.classList.remove('opacity-0', 'invisible');
            }

            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-24 right-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl shadow-2xl z-50 animate-fadeInUp';
            notification.innerHTML = `<div class="flex items-center gap-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><div><strong>Added to cart!</strong><br><span class="text-sm">${escapeHtml(name)}</span></div></div>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function updateQuantity(id, change) {
            const item = cart.find(item => item.id === id);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(id);
                } else {
                    updateCartUI();
                }
            }
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            updateCartUI();
        }

        function toggleCart() {
            const drawer = document.getElementById('cart-drawer');
            const overlay = document.getElementById('cart-overlay');

            if (!drawer || !overlay) return;

            const isOpen = !drawer.classList.contains('translate-x-full');

            if (isOpen) {
                drawer.classList.add('translate-x-full');
                overlay.classList.add('opacity-0', 'invisible');
            } else {
                drawer.classList.remove('translate-x-full');
                overlay.classList.remove('opacity-0', 'invisible');
                updateCartUI();
            }
        }

        function checkout() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            const cartData = encodeURIComponent(JSON.stringify(cart));
            window.location.href = `/checkout?cart=${cartData}`;
        }

        // Initialize cart on page load
        updateCartUI();

        // ============================================
        // USER AUTHENTICATION FUNCTIONS
        // ============================================

        function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');

            const loginButton = document.getElementById('login-button');
            const userMenu = document.getElementById('user-menu');
            const mobileGuestSection = document.getElementById('mobile-guest-section');
            const mobileUserSection = document.getElementById('mobile-user-section');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');

            if (token && userData) {
                if (loginButton) {
                    loginButton.classList.add('hidden');
                    loginButton.classList.remove('md:flex');
                }
                if (userMenu) {
                    userMenu.classList.remove('hidden');
                    userMenu.classList.add('flex');
                }

                if (mobileGuestSection) mobileGuestSection.classList.add('hidden');
                if (mobileUserSection) mobileUserSection.classList.remove('hidden');
                if (mobileLogoutBtn) mobileLogoutBtn.style.display = 'flex';

                try {
                    const user = JSON.parse(userData);
                    const initial = user.full_name ? user.full_name.charAt(0).toUpperCase() : 'U';
                    const fullName = user.full_name || user.username || 'User';

                    if (document.getElementById('user-avatar')) document.getElementById('user-avatar').textContent = initial;
                    if (document.getElementById('user-name')) document.getElementById('user-name').textContent = fullName;
                    if (document.getElementById('mobile-user-avatar')) document.getElementById('mobile-user-avatar').textContent = initial;
                    if (document.getElementById('mobile-user-name')) document.getElementById('mobile-user-name').textContent = fullName;
                    if (document.getElementById('mobile-user-email')) document.getElementById('mobile-user-email').textContent = user.email || '';
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            } else {
                if (loginButton) {
                    loginButton.classList.remove('hidden');
                    loginButton.classList.add('md:flex');
                }
                if (userMenu) {
                    userMenu.classList.add('hidden');
                    userMenu.classList.remove('flex');
                }

                if (mobileGuestSection) mobileGuestSection.classList.remove('hidden');
                if (mobileUserSection) mobileUserSection.classList.add('hidden');
                if (mobileLogoutBtn) mobileLogoutBtn.style.display = 'none';
            }
        }

        // Position navbar below announcement bar
        function updateNavPosition() {
            const bar = document.getElementById('announcement-bar');
            const nav = document.getElementById('main-nav');
            if (bar && nav) {
                nav.style.top = bar.offsetHeight + 'px';
            }
        }
        updateNavPosition();
        window.addEventListener('resize', updateNavPosition);

        // Sticky Header scroll effect
        window.addEventListener('scroll', () => {
            const nav = document.getElementById('main-nav');
            if (nav) {
                if (window.scrollY > 50) {
                    nav.classList.add('sticky-header-modern', 'shadow-md', 'py-2');
                    nav.classList.remove('py-4');
                } else {
                    nav.classList.remove('sticky-header-modern', 'shadow-md', 'py-2');
                    nav.classList.add('py-4');
                }
                updateNavPosition();
            }
        });

        function openLoginModal() {
            const modal = document.getElementById('login-modal');
            if (modal) modal.classList.add('active');
        }

        function closeLoginModal() {
            const modal = document.getElementById('login-modal');
            if (modal) modal.classList.remove('active');
        }

        function showRegisterForm() {
            closeLoginModal();
            setTimeout(() => {
                const modal = document.getElementById('register-modal');
                if (modal) modal.classList.add('active');
            }, 300);
        }

        function openRegisterModal() {
            const modal = document.getElementById('register-modal');
            if (modal) modal.classList.add('active');
        }

        function closeRegisterModal() {
            const modal = document.getElementById('register-modal');
            if (modal) modal.classList.remove('active');
        }

        function showLoginForm() {
            closeRegisterModal();
            setTimeout(() => {
                const modal = document.getElementById('login-modal');
                if (modal) modal.classList.add('active');
            }, 300);
        }

        // Login Required Modal Functions (for protected actions)
        function openLoginRequiredModal() {
            const modal = document.getElementById('login-required-modal');
            if (modal) modal.classList.add('active');
        }

        function closeLoginRequiredModal() {
            const modal = document.getElementById('login-required-modal');
            if (modal) modal.classList.remove('active');
        }

        // ============================================
        // FIREBASE PHONE AUTH FUNCTIONS
        // ============================================
        let confirmationResult = null;

        // Initialize reCAPTCHA (invisible)
        function initRecaptcha() {
            if (typeof firebase !== 'undefined' && firebase.auth && !window.recaptchaVerifier) {
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log('reCAPTCHA solved');
                    }
                });
            }
        }

        // Switch between Email and Phone login tabs
        function switchLoginTab(tab) {
            const emailTab = document.getElementById('email-tab');
            const phoneTab = document.getElementById('phone-tab');
            const emailForm = document.getElementById('login-form');
            const phoneForm = document.getElementById('phone-login-form');

            if (!emailTab || !phoneTab) return;

            if (tab === 'phone') {
                emailTab.classList.remove('border-purple-600', 'text-purple-600');
                emailTab.classList.add('border-transparent', 'text-gray-500');
                phoneTab.classList.add('border-purple-600', 'text-purple-600');
                phoneTab.classList.remove('border-transparent', 'text-gray-500');
                if (emailForm) emailForm.classList.add('hidden');
                if (phoneForm) phoneForm.classList.remove('hidden');
                initRecaptcha();
            } else {
                phoneTab.classList.remove('border-purple-600', 'text-purple-600');
                phoneTab.classList.add('border-transparent', 'text-gray-500');
                emailTab.classList.add('border-purple-600', 'text-purple-600');
                emailTab.classList.remove('border-transparent', 'text-gray-500');
                if (phoneForm) phoneForm.classList.add('hidden');
                if (emailForm) emailForm.classList.remove('hidden');
            }
        }

        // Send OTP via Firebase
        async function sendPhoneOTP() {
            const phoneNumber = document.getElementById('phone-number').value;
            const errorDiv = document.getElementById('phone-error');
            const sendBtn = document.getElementById('send-otp-btn');

            if (phoneNumber.length !== 10 || !/^\d+$/.test(phoneNumber)) {
                errorDiv.textContent = 'Please enter a valid 10-digit phone number';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';
                errorDiv.classList.add('hidden');

                const fullNumber = '+91' + phoneNumber;
                confirmationResult = await firebase.auth().signInWithPhoneNumber(fullNumber, window.recaptchaVerifier);

                document.getElementById('otp-section').classList.remove('hidden');
                document.getElementById('phone-input-section').classList.add('hidden');
                sendBtn.textContent = 'OTP Sent!';

            } catch (error) {
                console.error('Send OTP error:', error);
                errorDiv.textContent = error.message || 'Failed to send OTP. Please try again.';
                errorDiv.classList.remove('hidden');
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send OTP';

                // Reset reCAPTCHA on error
                if (window.recaptchaVerifier) {
                    window.recaptchaVerifier.render().then(widgetId => {
                        grecaptcha.reset(widgetId);
                    }).catch(e => console.error('reCAPTCHA reset error:', e));
                }
            }
        }

        // Verify OTP and login
        async function verifyPhoneOTP() {
            const otpCode = document.getElementById('otp-code').value;
            const errorDiv = document.getElementById('phone-error');
            const verifyBtn = document.querySelector('#otp-section button');

            if (otpCode.length !== 6 || !/^\d+$/.test(otpCode)) {
                errorDiv.textContent = 'Please enter the 6-digit OTP';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                errorDiv.classList.add('hidden');
                if (verifyBtn) {
                    verifyBtn.disabled = true;
                    verifyBtn.textContent = 'Verifying...';
                }

                // Verify with Firebase
                const result = await confirmationResult.confirm(otpCode);
                const idToken = await result.user.getIdToken();

                // Send to backend for user creation/login
                const response = await fetch('/api/firebase/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idToken })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    checkAuthStatus();
                    closeLoginModal();

                    // Show success message
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-24 right-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl shadow-2xl z-50 animate-fadeInUp';
                    notification.innerHTML = '<div class="flex items-center gap-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Login successful!</span></div>';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);

                    // Reload to update UI
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.classList.remove('hidden');
                    if (verifyBtn) {
                        verifyBtn.disabled = false;
                        verifyBtn.textContent = 'Verify & Login';
                    }
                }

            } catch (error) {
                console.error('Verify OTP error:', error);
                errorDiv.textContent = error.message || 'Invalid OTP. Please try again.';
                errorDiv.classList.remove('hidden');
                if (verifyBtn) {
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'Verify & Login';
                }
            }
        }

        // Reset phone login form (legacy - kept for compatibility)
        function resetPhoneLoginForm() {
            const phoneInput = document.getElementById('phone-number');
            const otpInput = document.getElementById('otp-code');
            const otpSection = document.getElementById('otp-section');
            const phoneInputSection = document.getElementById('phone-input-section');
            const sendBtn = document.getElementById('send-otp-btn');
            const errorDiv = document.getElementById('phone-error');

            if (phoneInput) phoneInput.value = '';
            if (otpInput) otpInput.value = '';
            if (otpSection) otpSection.classList.add('hidden');
            if (phoneInputSection) phoneInputSection.classList.remove('hidden');
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send OTP';
            }
            if (errorDiv) errorDiv.classList.add('hidden');
            confirmationResult = null;
        }

        // ============================================
        // UNIFIED AUTH FLOW - NEW FUNCTIONS
        // ============================================

        // Registration state
        let registrationData = {};
        let registrationConfirmationResult = null;

        // Login state
        let loginIdentifierType = null; // 'email' or 'phone'
        let loginConfirmationResult = null;

        // Helper functions
        function showError(element, message) {
            element.className = 'bg-red-100 text-red-600 p-3 rounded-xl text-sm text-center font-medium';
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function showSuccess(element, message) {
            element.className = 'bg-green-100 text-green-700 p-3 rounded-xl text-sm text-center font-medium';
            element.textContent = message;
            element.classList.remove('hidden');
        }

        // ============================================
        // REGISTRATION FLOW
        // ============================================

        function proceedToVerification() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const phone = document.getElementById('register-phone').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;
            const termsAccepted = document.getElementById('register-terms').checked;
            const verifyMethod = document.querySelector('input[name="verify-method"]:checked').value;
            const errorDiv = document.getElementById('register-error');
            const continueBtn = document.getElementById('register-continue-btn');

            // Validation
            if (!name || !email || !phone || !password || !confirmPassword) {
                showError(errorDiv, 'All fields are required');
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showError(errorDiv, 'Please enter a valid email address');
                return;
            }

            if (phone.length !== 10 || !/^\d+$/.test(phone)) {
                showError(errorDiv, 'Please enter a valid 10-digit phone number');
                return;
            }

            if (password.length < 6) {
                showError(errorDiv, 'Password must be at least 6 characters');
                return;
            }

            if (password !== confirmPassword) {
                showError(errorDiv, 'Passwords do not match');
                return;
            }

            if (!termsAccepted) {
                showError(errorDiv, 'Please accept the Terms & Conditions');
                return;
            }

            // Store registration data
            registrationData = { name, email, phone, password, verifyMethod };

            // Hide error and disable button
            errorDiv.classList.add('hidden');
            continueBtn.disabled = true;
            continueBtn.textContent = 'Processing...';

            // Update Step 2 UI based on verification method
            const verificationIcon = document.getElementById('verification-icon');
            const verificationMessage = document.getElementById('verification-message');

            if (verifyMethod === 'phone') {
                verificationIcon.className = 'fas fa-mobile-alt text-2xl text-blue-600';
                verificationMessage.textContent = `Enter the 6-digit code sent to +91 ${phone}`;
                // Initialize Firebase reCAPTCHA and send OTP
                initRegisterRecaptcha();
                sendRegistrationPhoneOTP();
            } else {
                verificationIcon.className = 'fas fa-envelope text-2xl text-blue-600';
                verificationMessage.textContent = `Enter the 6-digit code sent to ${email}`;
                // Send email OTP via backend
                sendRegistrationEmailOTP();
            }
        }

        function initRegisterRecaptcha() {
            if (typeof firebase !== 'undefined' && firebase.auth && !window.registerRecaptchaVerifier) {
                window.registerRecaptchaVerifier = new firebase.auth.RecaptchaVerifier('register-recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log('Register reCAPTCHA solved');
                    }
                });
            }
        }

        async function sendRegistrationPhoneOTP() {
            const errorDiv = document.getElementById('register-error');
            const continueBtn = document.getElementById('register-continue-btn');
            try {
                const fullNumber = '+91' + registrationData.phone;
                registrationConfirmationResult = await firebase.auth().signInWithPhoneNumber(
                    fullNumber,
                    window.registerRecaptchaVerifier
                );
                console.log('Registration phone OTP sent');

                // Show Step 2
                document.getElementById('register-step-1').classList.add('hidden');
                document.getElementById('register-step-2').classList.remove('hidden');
            } catch (error) {
                console.error('Send registration OTP error:', error);
                showError(errorDiv, error.message || 'Failed to send OTP. Please try again.');
            } finally {
                continueBtn.disabled = false;
                continueBtn.textContent = 'Continue to Verification';
            }
        }

        async function sendRegistrationEmailOTP() {
            const errorDiv = document.getElementById('register-error');
            const continueBtn = document.getElementById('register-continue-btn');
            try {
                // Create the user account (email verification will happen after)
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: registrationData.name,
                        email: registrationData.email,
                        phone: registrationData.phone,
                        username: registrationData.email.split('@')[0] + '_' + Date.now(),
                        password: registrationData.password
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Registration failed');
                }

                // Store token temporarily (user not verified yet)
                registrationData.tempToken = data.access_token;
                registrationData.tempUser = data.user;

                console.log('Email OTP sent during registration');

                // Show Step 2
                document.getElementById('register-step-1').classList.add('hidden');
                document.getElementById('register-step-2').classList.remove('hidden');
            } catch (error) {
                console.error('Registration email OTP error:', error);
                showError(errorDiv, error.message);
            } finally {
                continueBtn.disabled = false;
                continueBtn.textContent = 'Continue to Verification';
            }
        }

        async function verifyRegistrationOTP() {
            const otpCode = document.getElementById('register-otp').value;
            const errorDiv = document.getElementById('register-error');
            const verifyBtn = document.getElementById('verify-register-otp-btn');

            if (otpCode.length !== 6 || !/^\d+$/.test(otpCode)) {
                showError(errorDiv, 'Please enter the 6-digit OTP');
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifying...';

            if (registrationData.verifyMethod === 'phone') {
                await verifyRegistrationPhoneOTP(otpCode);
            } else {
                await verifyRegistrationEmailOTP(otpCode);
            }

            verifyBtn.disabled = false;
            verifyBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Verify & Create Account';
        }

        async function verifyRegistrationPhoneOTP(otpCode) {
            const errorDiv = document.getElementById('register-error');
            try {
                // Verify with Firebase
                const result = await registrationConfirmationResult.confirm(otpCode);
                const idToken = await result.user.getIdToken();

                // Create user account with phone verification
                const response = await fetch('/api/register-with-phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: registrationData.name,
                        email: registrationData.email,
                        phone: registrationData.phone,
                        password: registrationData.password,
                        firebase_token: idToken
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    completeRegistration(data);
                } else {
                    throw new Error(data.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Phone OTP verification error:', error);
                showError(errorDiv, error.message || 'Invalid OTP. Please try again.');
            }
        }

        async function verifyRegistrationEmailOTP(otpCode) {
            const errorDiv = document.getElementById('register-error');
            try {
                const response = await fetch('/api/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: registrationData.email,
                        otp_code: otpCode
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    // Use the stored token and user from registration
                    completeRegistration({
                        access_token: registrationData.tempToken,
                        user: { ...registrationData.tempUser, email_verified: true }
                    });
                } else {
                    throw new Error(data.error || 'Invalid OTP');
                }
            } catch (error) {
                console.error('Email OTP verification error:', error);
                showError(errorDiv, error.message);
            }
        }

        function completeRegistration(data) {
            localStorage.setItem('token', data.access_token);
            localStorage.setItem('user', JSON.stringify(data.user));
            checkAuthStatus();

            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-24 right-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl shadow-2xl z-50';
            notification.innerHTML = '<div class="flex items-center gap-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Account created successfully!</span></div>';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
                closeRegisterModal();
                resetRegisterForm();
                window.location.reload();
            }, 1500);
        }

        function goBackToStep1() {
            document.getElementById('register-step-1').classList.remove('hidden');
            document.getElementById('register-step-2').classList.add('hidden');
            document.getElementById('register-otp').value = '';
            document.getElementById('register-error').classList.add('hidden');
        }

        function resetRegisterForm() {
            document.getElementById('register-name').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-phone').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-confirm').value = '';
            document.getElementById('register-terms').checked = false;
            document.getElementById('register-otp').value = '';
            document.getElementById('register-step-1').classList.remove('hidden');
            document.getElementById('register-step-2').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
            document.querySelector('input[name="verify-method"][value="email"]').checked = true;
            registrationData = {};
            registrationConfirmationResult = null;
        }

        async function resendRegistrationOTP() {
            const resendBtn = document.getElementById('resend-otp-btn');
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';

            if (registrationData.verifyMethod === 'phone') {
                await sendRegistrationPhoneOTP();
            } else {
                // Resend email OTP
                await fetch('/api/resend-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: registrationData.email })
                });
            }

            resendBtn.disabled = false;
            resendBtn.textContent = 'Resend OTP';
        }

        // ============================================
        // LOGIN FLOW
        // ============================================

        function detectInputType(value) {
            const hint = document.getElementById('input-type-hint');
            const methodSelector = document.getElementById('login-method-selector');
            const passwordSection = document.getElementById('password-input-section');
            const otpSection = document.getElementById('otp-request-section');

            value = value.trim();

            if (!value) {
                hint.classList.add('hidden');
                methodSelector.classList.add('hidden');
                passwordSection.classList.add('hidden');
                otpSection.classList.add('hidden');
                loginIdentifierType = null;
                return;
            }

            // Detect if email (contains @) or phone (10 digits)
            if (value.includes('@')) {
                loginIdentifierType = 'email';
                hint.textContent = 'Detected: Email address';
                hint.classList.remove('hidden');
                methodSelector.classList.remove('hidden');
                switchLoginMethod('password');
            } else if (/^\d{10}$/.test(value)) {
                loginIdentifierType = 'phone';
                hint.textContent = 'Detected: Phone number (+91)';
                hint.classList.remove('hidden');
                methodSelector.classList.remove('hidden');
                switchLoginMethod('password');
            } else if (/^\d+$/.test(value) && value.length < 10) {
                loginIdentifierType = null;
                hint.textContent = `Enter ${10 - value.length} more digits for phone`;
                hint.classList.remove('hidden');
                methodSelector.classList.add('hidden');
                passwordSection.classList.add('hidden');
                otpSection.classList.add('hidden');
            } else {
                loginIdentifierType = null;
                hint.classList.add('hidden');
                methodSelector.classList.add('hidden');
                passwordSection.classList.add('hidden');
                otpSection.classList.add('hidden');
            }
        }

        function switchLoginMethod(method) {
            const identifier = document.getElementById('login-identifier').value.trim();
            const passwordSection = document.getElementById('password-input-section');
            const otpSection = document.getElementById('otp-request-section');
            const otpDestination = document.getElementById('otp-destination');

            // Update radio button state
            document.querySelector(`input[name="login-method"][value="${method}"]`).checked = true;

            if (method === 'password') {
                passwordSection.classList.remove('hidden');
                otpSection.classList.add('hidden');
            } else {
                passwordSection.classList.add('hidden');
                otpSection.classList.remove('hidden');

                // Update destination display
                if (loginIdentifierType === 'phone') {
                    otpDestination.textContent = '+91 ' + identifier;
                } else {
                    otpDestination.textContent = identifier;
                }
            }
        }

        async function loginWithPassword() {
            const identifier = document.getElementById('login-identifier').value.trim();
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-password-btn');

            if (!identifier || !password) {
                showError(errorDiv, 'Please enter both identifier and password');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: loginIdentifierType === 'email' ? identifier : null,
                        phone: loginIdentifierType === 'phone' ? identifier : null,
                        password: password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    checkAuthStatus();

                    showSuccess(errorDiv, 'Login successful! Redirecting...');
                    setTimeout(() => {
                        closeLoginModal();
                        resetLoginForm();
                        window.location.reload();
                    }, 1000);
                } else {
                    showError(errorDiv, data.error || 'Invalid credentials');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError(errorDiv, 'Network error. Please try again.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        function initLoginRecaptcha() {
            if (typeof firebase !== 'undefined' && firebase.auth && !window.loginRecaptchaVerifier) {
                window.loginRecaptchaVerifier = new firebase.auth.RecaptchaVerifier('login-recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log('Login reCAPTCHA solved');
                    }
                });
            }
        }

        async function requestLoginOTP() {
            const identifier = document.getElementById('login-identifier').value.trim();
            const errorDiv = document.getElementById('login-error');
            const requestBtn = document.getElementById('request-otp-btn');

            requestBtn.disabled = true;
            requestBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';

            try {
                if (loginIdentifierType === 'phone') {
                    // Firebase phone OTP
                    initLoginRecaptcha();
                    const fullNumber = '+91' + identifier;
                    loginConfirmationResult = await firebase.auth().signInWithPhoneNumber(
                        fullNumber,
                        window.loginRecaptchaVerifier
                    );

                    document.getElementById('login-otp-message').textContent =
                        `Enter the 6-digit code sent to +91 ${identifier}`;
                } else {
                    // Email OTP via backend
                    const response = await fetch('/api/send-login-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: identifier })
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to send OTP');
                    }

                    document.getElementById('login-otp-message').textContent =
                        `Enter the 6-digit code sent to ${identifier}`;
                }

                // Show OTP input
                document.getElementById('login-step-1').classList.add('hidden');
                document.getElementById('login-step-2').classList.remove('hidden');

            } catch (error) {
                console.error('Request OTP error:', error);
                showError(errorDiv, error.message || 'Failed to send OTP');
            } finally {
                requestBtn.disabled = false;
                requestBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send OTP';
            }
        }

        async function verifyLoginOTP() {
            const otpCode = document.getElementById('login-otp-code').value;
            const identifier = document.getElementById('login-identifier').value.trim();
            const errorDiv = document.getElementById('login-error');
            const verifyBtn = document.getElementById('verify-login-otp-btn');

            if (otpCode.length !== 6 || !/^\d+$/.test(otpCode)) {
                showError(errorDiv, 'Please enter the 6-digit OTP');
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verifying...';

            try {
                let response, data;

                if (loginIdentifierType === 'phone') {
                    // Verify Firebase OTP
                    const result = await loginConfirmationResult.confirm(otpCode);
                    const idToken = await result.user.getIdToken();

                    // Send to backend
                    response = await fetch('/api/firebase/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idToken })
                    });
                    data = await response.json();
                } else {
                    // Verify email OTP
                    response = await fetch('/api/verify-login-otp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: identifier,
                            otp_code: otpCode
                        })
                    });
                    data = await response.json();
                }

                if (response.ok) {
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    checkAuthStatus();

                    showSuccess(errorDiv, 'Login successful!');
                    setTimeout(() => {
                        closeLoginModal();
                        resetLoginForm();
                        window.location.reload();
                    }, 1000);
                } else {
                    showError(errorDiv, data.error || 'Invalid OTP');
                }
            } catch (error) {
                console.error('Verify OTP error:', error);
                showError(errorDiv, error.message || 'Invalid OTP. Please try again.');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Verify & Login';
            }
        }

        function resetLoginForm() {
            const identifierInput = document.getElementById('login-identifier');
            const passwordInput = document.getElementById('login-password');
            const otpInput = document.getElementById('login-otp-code');
            const step1 = document.getElementById('login-step-1');
            const step2 = document.getElementById('login-step-2');
            const methodSelector = document.getElementById('login-method-selector');
            const passwordSection = document.getElementById('password-input-section');
            const otpSection = document.getElementById('otp-request-section');
            const errorDiv = document.getElementById('login-error');
            const hint = document.getElementById('input-type-hint');

            if (identifierInput) identifierInput.value = '';
            if (passwordInput) passwordInput.value = '';
            if (otpInput) otpInput.value = '';
            if (step1) step1.classList.remove('hidden');
            if (step2) step2.classList.add('hidden');
            if (methodSelector) methodSelector.classList.add('hidden');
            if (passwordSection) passwordSection.classList.add('hidden');
            if (otpSection) otpSection.classList.add('hidden');
            if (errorDiv) errorDiv.classList.add('hidden');
            if (hint) hint.classList.add('hidden');

            loginIdentifierType = null;
            loginConfirmationResult = null;
        }

        // Check if user is logged in
        function isUserLoggedIn() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            return !!(token && user);
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) dropdown.classList.toggle('hidden');
        }

        document.addEventListener('click', function (event) {
            const userMenu = document.getElementById('user-menu');
            const dropdown = document.getElementById('user-dropdown');

            if (userMenu && dropdown && !userMenu.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            checkAuthStatus();
            alert('Logged out successfully!');
            window.location.href = '/';
        }

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    document.querySelector('.mobile-menu')?.classList.add('hidden');
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Scroll Reveal Animation
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -100px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.scroll-reveal').forEach(el => observer.observe(el));

        // Initialize auth forms
        document.addEventListener('DOMContentLoaded', function () {
            checkAuthStatus();

            // Login form handler
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;

                    try {
                        const response = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            localStorage.setItem('token', data.access_token);
                            localStorage.setItem('user', JSON.stringify(data.user));
                            checkAuthStatus();

                            const errorDiv = document.getElementById('login-error');
                            errorDiv.className = 'bg-green-100 text-green-700 p-3 rounded mb-4 text-center text-sm font-medium';
                            errorDiv.textContent = 'Login successful! Redirecting...';
                            errorDiv.classList.remove('hidden');

                            // Check if there's a pending booking
                            const pendingBooking = localStorage.getItem('pendingBooking');

                            setTimeout(() => {
                                closeLoginModal();
                                if (pendingBooking) {
                                    // Redirect to home page to continue booking
                                    window.location.href = '/#pandits';
                                } else {
                                    window.location.href = '/';
                                }
                            }, 1000);
                        } else {
                            const errorDiv = document.getElementById('login-error');
                            errorDiv.className = 'bg-red-100 text-red-600 p-3 rounded mb-4 text-center text-sm font-medium';
                            errorDiv.textContent = data.error || 'Invalid credentials';
                            errorDiv.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        alert('Network error. Please try again.');
                    }
                });
            }

            // Register form handler
            const registerForm = document.getElementById('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const name = document.getElementById('register-name').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const confirmPassword = document.getElementById('register-confirm').value;

                    if (password !== confirmPassword) {
                        const errorDiv = document.getElementById('register-error');
                        errorDiv.className = 'bg-red-100 text-red-600 p-3 rounded mb-4 text-center text-sm font-medium';
                        errorDiv.textContent = 'Passwords do not match!';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    if (password.length < 6) {
                        const errorDiv = document.getElementById('register-error');
                        errorDiv.className = 'bg-red-100 text-red-600 p-3 rounded mb-4 text-center text-sm font-medium';
                        errorDiv.textContent = 'Password must be at least 6 characters long';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    try {
                        const response = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                full_name: name,
                                email: email,
                                username: email.split('@')[0],
                                password: password
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            localStorage.setItem('token', data.access_token);
                            localStorage.setItem('user', JSON.stringify(data.user));
                            checkAuthStatus();

                            const errorDiv = document.getElementById('register-error');
                            errorDiv.className = 'bg-green-100 text-green-700 p-3 rounded mb-4 text-center text-sm font-medium';
                            errorDiv.textContent = 'Registration successful! Redirecting...';
                            errorDiv.classList.remove('hidden');

                            // Check if there's a pending booking
                            const pendingBooking = localStorage.getItem('pendingBooking');

                            setTimeout(() => {
                                closeRegisterModal();
                                registerForm.reset();
                                if (pendingBooking) {
                                    // Redirect to home page to continue booking
                                    window.location.href = '/#pandits';
                                } else {
                                    window.location.href = '/user/dashboard';
                                }
                            }, 1500);
                        } else {
                            const errorDiv = document.getElementById('register-error');
                            errorDiv.className = 'bg-red-100 text-red-600 p-3 rounded mb-4 text-center text-sm font-medium';
                            errorDiv.textContent = data.error || 'Please try again';
                            errorDiv.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error('Registration error:', error);
                        alert('Network error. Please try again.');
                    }
                });
            }

            // Close modals when clicking outside
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.addEventListener('click', function (e) {
                    if (e.target === this) closeLoginModal();
                });
            }

            const registerModal = document.getElementById('register-modal');
            if (registerModal) {
                registerModal.addEventListener('click', function (e) {
                    if (e.target === this) closeRegisterModal();
                });
            }

            const loginRequiredModal = document.getElementById('login-required-modal');
            if (loginRequiredModal) {
                loginRequiredModal.addEventListener('click', function (e) {
                    if (e.target === this) closeLoginRequiredModal();
                });
            }
        });

        window.addEventListener('pageshow', checkAuthStatus);
    </script>

    {% block extra_scripts %}{% endblock %}
</body>

</html>
