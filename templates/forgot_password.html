{% extends "base.html" %}

{% block title %}Forgot Password - PujaPath{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gray-50">
    <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-xl">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto bg-purple-100 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-key text-2xl text-purple-600"></i>
            </div>
            <h2 class="mt-2 text-3xl font-extrabold text-gray-900">Forgot Password?</h2>
            <p class="mt-2 text-sm text-gray-600">
                Enter your email or phone number to reset your password.
            </p>
        </div>

        <div id="unified-reset-section">
            <div class="space-y-6">
                <!-- Single Input for Email or Phone -->
                <div id="input-step">
                    <div>
                        <label for="reset-identifier" class="block text-sm font-medium text-gray-700 mb-1">Email or
                            Phone Number</label>
                        <input id="reset-identifier" type="text" required
                            class="appearance-none rounded-xl relative block w-full px-4 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                            placeholder="email@example.com or 10-digit phone" oninput="detectResetInput(this.value)">
                    </div>

                    <div id="reset-error" class="hidden mt-2 text-sm text-red-600 text-center"></div>
                    <div id="reset-recaptcha-container"></div>

                    <button type="button" onclick="handleResetSubmit()" id="reset-submit-btn"
                        class="mt-6 group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 shadow-lg transform transition hover:-translate-y-0.5">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <i id="reset-btn-icon"
                                class="fas fa-paper-plane text-purple-200 group-hover:text-purple-100"></i>
                        </span>
                        <span id="reset-btn-text">Continue</span>
                    </button>
                </div>

                <!-- OTP Step (Phone only) -->
                <div id="otp-step" class="hidden text-center">
                    <div class="mb-4">
                        <p class="text-gray-600 text-sm">Enter the 6-digit code sent to <span id="otp-sent-to"
                                class="font-bold"></span></p>
                    </div>

                    <input type="text" id="reset-otp" maxlength="6" pattern="[0-9]{6}"
                        class="w-full px-4 py-4 border border-gray-300 rounded-xl text-center text-2xl tracking-widest font-bold focus:ring-2 focus:ring-purple-500 focus:border-transparent mb-6"
                        placeholder="------" oninput="this.value = this.value.replace(/[^0-9]/g, '')">

                    <button type="button" onclick="verifyResetOTP()" id="verify-otp-btn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-lg transform transition hover:-translate-y-0.5">
                        Verify & Reset
                    </button>

                    <button onclick="resetUnifiedForm()" class="mt-4 text-sm text-purple-600 hover:text-purple-800">
                        Change Details
                    </button>
                </div>
            </div>

            <!-- Hidden form for Email submission -->
            <form id="email-reset-form" action="{{ url_for('forgot_password') }}" method="POST" class="hidden">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="email" id="hidden-email-input">
            </form>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="mt-4 rounded-md bg-{{ 'green' if category == 'success' else 'red' }}-50 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        {% if category == 'success' %}
                        <i class="fas fa-check-circle text-green-400"></i>
                        {% else %}
                        <i class="fas fa-exclamation-circle text-red-400"></i>
                        {% endif %}
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-{{ 'green' if category == 'success' else 'red' }}-800">
                            {{ message }}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="text-center pt-6 border-t border-gray-100 mt-6">
                <a href="{{ url_for('home') }}" class="font-medium text-purple-600 hover:text-purple-500">
                    <i class="fas fa-arrow-left mr-1"></i> Back to Home
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    let resetType = 'email'; // Default
    let resetConfirmationResult = null;
    let resetRecaptchaVerifier = null;

    function detectResetInput(value) {
        const isNumeric = /^\d+$/.test(value);
        const btnText = document.getElementById('reset-btn-text');
        const btnIcon = document.getElementById('reset-btn-icon');

        if (isNumeric && value.length > 5) {
            resetType = 'phone';
            btnText.textContent = 'Send OTP';
            btnIcon.className = 'fas fa-mobile-alt text-purple-200 group-hover:text-purple-100';
            initResetRecaptcha();
        } else {
            resetType = 'email';
            btnText.textContent = 'Send Reset Link';
            btnIcon.className = 'fas fa-paper-plane text-purple-200 group-hover:text-purple-100';
        }
    }

    function initResetRecaptcha() {
        if (!resetRecaptchaVerifier && typeof firebase !== 'undefined' && firebase.auth) {
            try {
                resetRecaptchaVerifier = new firebase.auth.RecaptchaVerifier('reset-recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log('Reset reCAPTCHA solved');
                    }
                });
            } catch (e) {
                console.log("Recaptcha already initialized or error", e);
            }
        }
    }

    async function handleResetSubmit() {
        const value = document.getElementById('reset-identifier').value.trim();
        const errorDiv = document.getElementById('reset-error');
        const btn = document.getElementById('reset-submit-btn');

        errorDiv.classList.add('hidden');
        errorDiv.textContent = "";

        if (!value) {
            errorDiv.textContent = "Please enter your email or phone number";
            errorDiv.classList.remove('hidden');
            return;
        }

        if (resetType === 'email') {
            // Validate Email
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                errorDiv.textContent = "Please enter a valid email address";
                errorDiv.classList.remove('hidden');
                return;
            }
            // Submit Email Form
            document.getElementById('hidden-email-input').value = value;
            document.getElementById('email-reset-form').submit();
        } else {
            // Validate Phone
            if (value.length !== 10) {
                errorDiv.textContent = "Please enter a valid 10-digit phone number";
                errorDiv.classList.remove('hidden');
                return;
            }

            // Trigger OTP
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

                const fullNumber = '+91' + value;
                resetConfirmationResult = await firebase.auth().signInWithPhoneNumber(fullNumber, resetRecaptchaVerifier);

                document.getElementById('otp-sent-to').textContent = fullNumber;
                document.getElementById('input-step').classList.add('hidden');
                document.getElementById('otp-step').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                errorDiv.textContent = error.message || "Failed to send OTP.";
                errorDiv.classList.remove('hidden');
                btn.disabled = false;
                detectResetInput(value); // Restores button text

                if (resetRecaptchaVerifier) {
                    resetRecaptchaVerifier.clear();
                    resetRecaptchaVerifier = null;
                    initResetRecaptcha();
                }
            }
        }
    }

    async function verifyResetOTP() {
        const otp = document.getElementById('reset-otp').value;
        const verifyBtn = document.getElementById('verify-otp-btn');

        if (otp.length !== 6) {
            alert("Please enter 6-digit OTP");
            return;
        }

        try {
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

            console.log('Step 1: Confirming OTP with Firebase...');
            const result = await resetConfirmationResult.confirm(otp);
            console.log('Step 2: OTP confirmed, getting ID token...');
            const idToken = await result.user.getIdToken();
            console.log('Step 3: ID token obtained, length:', idToken.length);

            // Send to verify API
            console.log('Step 4: Sending to backend API...');
            const response = await fetch('/api/verify-reset-phone', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: idToken })
            });

            console.log('Step 5: Backend response status:', response.status);
            const data = await response.json();
            console.log('Step 6: Backend response data:', data);

            if (response.ok) {
                console.log('Step 7: Success! Redirecting...');
                window.location.href = data.redirect_url;
            } else {
                console.error('Backend returned error:', data.error);
                alert(data.error || "Verification failed");
                verifyBtn.disabled = false;
                verifyBtn.textContent = "Verify & Reset";
            }

        } catch (error) {
            console.error('Error during verification:', error);
            console.error('Error type:', error.constructor.name);
            console.error('Error message:', error.message);
            console.error('Error code:', error.code);
            alert("Invalid OTP or Verification Failed: " + (error.message || error.code || 'Unknown error'));
            verifyBtn.disabled = false;
            verifyBtn.textContent = "Verify & Reset";
        }
    }

    function resetUnifiedForm() {
        document.getElementById('input-step').classList.remove('hidden');
        document.getElementById('otp-step').classList.add('hidden');
        document.getElementById('reset-otp').value = '';

        const btn = document.getElementById('reset-submit-btn');
        btn.disabled = false;
        detectResetInput(document.getElementById('reset-identifier').value);
    }
</script>
{% endblock %}